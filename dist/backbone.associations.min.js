/**
 * Backbone.Associations v0.1.0
 * https://github.com/DreamTheater/Backbone.Associations
 *
 * Copyright Â© 2012 Dmytro Nemoga
 * Released under the MIT license.
 */
(function(){"use strict";var e=Backbone.Model;Backbone.Model=_.extend(function(t,n){n=_.extend({},n),this.associations=n.associations||this.associations||[],_.each(this.associations,function(e){var t=this._resolveRelation(e);this[t.type](t.name,t)},this),e.apply(this,arguments)},e,{prototype:_.extend(e.prototype,{belongsTo:function(e,t){return this._createReference(e,t,{getter:function(e){var n=this.get(t.foreignKey);return e.get(n)},setter:function(e,n,r){return this.set(t.foreignKey,n.id,r)},builder:function(e,t,n){var r=e.model;return new r(t,n)},creator:function(e,t,n){return e.create(t,n)}})},hasOne:function(e,t){return this._createReference(e,t,{getter:function(e){var n={};return n[t.foreignKey]=this.id,e.where(n)[0]},setter:function(e,n,r){return n.set(t.foreignKey,this.id,r)},builder:function(e,t,n){var r=e.model;return new r(t,n)},creator:function(e,t,n){return e.create(t,n)}})},hasMany:function(e,t){return this._createReference(e,t,{getter:function(e){return e}})},toJSON:_.wrap(e.prototype.toJSON,function(e,t){t=_.extend({associations:!1},t);var n=e.call(this,t);return n}),_createReference:function(e,t,n){var r=function(e){var n=this._resolveCollection(t);return e.call(this,n)},i=function(e,n,r){var i=this._resolveCollection(t);return e.call(this,i,n,r)},s=function(e,n,r){var i=this._resolveCollection(t);return e.call(this,i,n,r)},o=function(e,n,r){var i=this._resolveCollection(t);return e.call(this,i,n,r)};return _.isFunction(n.getter)&&(this["get"+e]=_.wrap(n.getter,r)),_.isFunction(n.setter)&&(this["set"+e]=_.wrap(n.setter,i)),_.isFunction(n.builder)&&(this["build"+e]=_.wrap(n.builder,s)),_.isFunction(n.creator)&&(this["create"+e]=_.wrap(n.creator,o)),this},_resolveRelation:function(e){var t=_.pick(e,["belongsTo","hasOne","hasMany"]),n=_.keys(t)[0],r=t[n];return{type:n,collection:r,name:e.as,foreignKey:e.by}},_resolveCollection:function(e){return _.result(e,"collection")}})}),Backbone.sync=_.wrap(Backbone.sync,function(e,t,n,r){if(t!=="read")return e.call(this,t,n,r);r=_.extend({},r);var i=$.Deferred(),s=_.bind(function(e,t,n){delete this._xhrCache,_.isFunction(e)&&e.call(this,this,t,n)},n),o=_.bind(function(e,t,n,s){i.resolve(t,n,s),_.isFunction(e)&&e.call(this,this,t,r)},n),u=_.bind(function(e,t,n,s){i.reject(t,n,s),_.isFunction(e)&&e.call(this,this,t,r)},n),a=_.bind(function(){_.isUndefined(this._xhrCache)?this._xhrCache=e.call(this,"read",n,r):this._xhrCache.then(i.resolve,i.reject)},n);_.extend(r,{complete:_.wrap(r.complete,s),success:_.wrap(r.success,o),error:_.wrap(r.error,u)});var f,l=[];return this instanceof Backbone.Model?f=this.associations:this instanceof Backbone.Collection&&(f=this.model.prototype.associations),_.isArray(f)||(f=[]),_.each(f,function(e){var t=Backbone.Model.prototype._resolveRelation.call(this,e),n=Backbone.Model.prototype._resolveCollection.call(this,t),i;n!==r.associate&&(i=n.fetch({associate:this}),l.push(i))},this),$.when.apply($,l).then(a),i.promise()})})();