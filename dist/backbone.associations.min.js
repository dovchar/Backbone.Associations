/**
 * Backbone.Associations v0.1.0
 * https://github.com/DreamTheater/Backbone.Associations
 *
 * Copyright Â© 2012 Dmytro Nemoga
 * Released under the MIT license.
 */
(function(){"use strict";var e=Backbone.Model;Backbone.Model=_.extend(function(t,n){n=_.extend({},n),_.isArray(n.associations)?this.associations=n.associations:_.isUndefined(this.associations)&&(this.associations=[]),_.each(this.associations,function(e){var t=_.pick(e,["belongsTo","hasOne","hasMany"]),n=_.keys(t)[0],r=t[n];this[n]({collection:r,name:e.as,foreignKey:e.by})},this),e.apply(this,arguments)},e,{prototype:_.extend(e.prototype,{belongsTo:function(e){return this._createReference({getter:function(t){var n=this.get(e.foreignKey);return t.get(n)},setter:function(t,n){return this.set(e.foreignKey,n.id)},builder:function(e,t){},creator:function(e,t){}},e)},hasOne:function(e){return this._createReference({getter:function(e){},setter:function(e,t){},builder:function(e,t){},creator:function(e,t){}},e)},hasMany:function(e){return this._createReference({getter:function(e){return e}},e)},toJSON:_.wrap(e.prototype.toJSON,function(e,t){t=_.extend({associations:!1},t);var n=e.call(this,t);return t.associations,n}),_createReference:function(e,t){return _.isFunction(e.getter)&&(this["get"+t.name]=_.wrap(e.getter,function(e){var n=this._resolveCollection(t);return e.call(this,n)})),_.isFunction(e.setter)&&(this["set"+t.name]=_.wrap(e.setter,function(e,n){var r=this._resolveCollection(t);return e.call(this,r,n)})),_.isFunction(e.builder)&&(this["build"+t.name]=_.wrap(e.builder,function(e,n){var r=this._resolveCollection(t);return e.call(this,r,n)})),_.isFunction(e.creator)&&(this["create"+t.name]=_.wrap(e.creator,function(e,n){var r=this._resolveCollection(t);return e.call(this,r,n)})),this},_resolveCollection:function(e){return _.result(e,"collection")}})}),Backbone.sync=_.wrap(Backbone.sync,function(e,t,n,r){if(t!=="read")return e.call(this,t,n,r);r=_.extend({},r);var i=$.Deferred(),s=_.bind(function(e,t,n){delete this._xhrCache,_.isFunction(e)&&e.call(this,this,t,n)},n),o=_.bind(function(e,t,n,s){i.resolve(t,n,s),_.isFunction(e)&&e.call(this,this,t,r)},n),u=_.bind(function(e,t,n,s){i.reject(t,n,s),_.isFunction(e)&&e.call(this,this,t,r)},n),a=_.bind(function(){_.isUndefined(this._xhrCache)?this._xhrCache=e.call(this,"read",n,r):this._xhrCache.then(i.resolve,i.reject)},n);_.extend(r,{complete:_.wrap(r.complete,s),success:_.wrap(r.success,o),error:_.wrap(r.error,u)});var f,l=[];return this instanceof Backbone.Model?f=this.associations:this instanceof Backbone.Collection&&(f=this.model.prototype.associations),_.isArray(f)&&_.each(f,function(e){}),$.when.apply($,l).then(a),i.promise()})})();