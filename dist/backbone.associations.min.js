/**
 * Backbone.Associations v0.1.0
 * https://github.com/DreamTheater/Backbone.Associations
 *
 * Copyright Â© 2012 Dmytro Nemoga
 * Released under the MIT license.
 */
(function(){"use strict";var a=Backbone.Model;Backbone.Model=_.extend(function(b,c){c=_.extend({},c),this.associations=c.associations||this.associations||{},_.each(this.associations,function(a){var b=_.pick(a,["belongsTo","hasOne","hasMany"]),c=_.keys(b)[0],d=b[c];this[c]({collection:d,name:a.as,foreignKey:a.by})},this),a.apply(this,arguments)},a,{prototype:_.extend(a.prototype,{belongsTo:function(a){return this._createReference({getter:function(b){var c=this.get(a.foreignKey);return b.get(c)},setter:function(b,c){return this.set(a.foreignKey,c.id)},builder:function(a,b){},creator:function(a,b){}},a)},hasOne:function(a){return this._createReference({getter:function(b){var c={};return c[a.foreignKey]=this.id,b.where(c)[0]},setter:function(a,b){},builder:function(a,b){},creator:function(a,b){}},a)},hasMany:function(a){return this._createReference({getter:function(a){return a}},a)},toJSON:_.wrap(a.prototype.toJSON,function(a,b){b=_.extend({associations:!1},b);var c=a.call(this,b);return!b.associations,c}),_createReference:function(a,b){return _.isFunction(a.getter)&&(this["get"+b.name]=_.wrap(a.getter,function(a){var c=this._resolveCollection(b);return a.call(this,c)})),_.isFunction(a.setter)&&(this["set"+b.name]=_.wrap(a.setter,function(a,c){var d=this._resolveCollection(b);return a.call(this,d,c)})),_.isFunction(a.builder)&&(this["build"+b.name]=_.wrap(a.builder,function(a,c){var d=this._resolveCollection(b);return a.call(this,d,c)})),_.isFunction(a.creator)&&(this["create"+b.name]=_.wrap(a.creator,function(a,c){var d=this._resolveCollection(b);return a.call(this,d,c)})),this},_resolveCollection:function(a){return _.result(a,"collection")}})}),Backbone.sync=_.wrap(Backbone.sync,function(a,b,c,d){if(b!=="read")return a.call(this,b,c,d);d=_.extend({},d);var e=$.Deferred(),f=_.bind(function(a,b,c){delete this._xhrCache,_.isFunction(a)&&a.call(this,this,b,c)},c),g=_.bind(function(a,b,c,f){e.resolve(b,c,f),_.isFunction(a)&&a.call(this,this,b,d)},c),h=_.bind(function(a,b,c,f){e.reject(b,c,f),_.isFunction(a)&&a.call(this,this,b,d)},c),i=_.bind(function(){_.isUndefined(this._xhrCache)?this._xhrCache=a.call(this,"read",c,d):this._xhrCache.then(e.resolve,e.reject)},c);_.extend(d,{complete:_.wrap(d.complete,f),success:_.wrap(d.success,g),error:_.wrap(d.error,h)});var j,k=[];return this instanceof Backbone.Model?j=this.associations:this instanceof Backbone.Collection&&(j=this.model.prototype.associations),_.isArray(j)&&_.each(j,function(a){}),$.when.apply($,k).then(i),e.promise()})})();