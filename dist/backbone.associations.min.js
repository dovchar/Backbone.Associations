/**
 * Backbone.Associations v0.1.0
 * https://github.com/DreamTheater/Backbone.Associations
 *
 * Copyright Â© 2012 Dmytro Nemoga
 * Released under the MIT license.
 */
(function(){"use strict";var e=Backbone.Model;Backbone.Model=_.extend(function(t,n){n=_.extend({},n),this.associations=n.associations||this.associations||[],_.each(this.associations,function(e){var t=this.constructor.resolveRelation(e);this[t.type](t.name,t)},this),e.apply(this,arguments)},e,{resolveRelation:function(e){var t=_.pick(e,["belongsTo","hasOne","hasMany"]),n=_.keys(t)[0],r=t[n];return{type:n,collection:r,name:e.as,foreignKey:e.by}},resolveCollection:function(e){return _.result(e,"collection")},prototype:_.extend(e.prototype,{belongsTo:function(e,t){return this._createReference(e,t,{getter:function(e){var n=this.get(t.foreignKey);return e.get(n)},setter:function(e,n,r){return this.set(t.foreignKey,n.id,r)},builder:function(e,t,n){var r=e.model;return new r(t,n)},creator:function(e,t,n){return e.create(t,n)}})},hasOne:function(e,t){return this._createReference(e,t,{getter:function(e){var n={};return n[t.foreignKey]=this.id,e.where(n)[0]},setter:function(e,n,r){return n.set(t.foreignKey,this.id,r)},builder:function(e,t,n){var r=e.model;return new r(t,n)},creator:function(e,t,n){return e.create(t,n)}})},hasMany:function(e,t){return this._createReference(e,t,{getter:function(e){return e}})},toJSON:_.wrap(e.prototype.toJSON,function(e,t){t=_.extend({associations:!1},t);var n=e.call(this,t);return n}),_createReference:function(e,t,n){var r=function(e){var n=this.constructor.resolveCollection(t);return e.call(this,n)},i=function(e,n,r){var i=this.constructor.resolveCollection(t);return e.call(this,i,n,r)},s=function(e,n,r){var i=this.constructor.resolveCollection(t);return e.call(this,i,n,r)},o=function(e,n,r){var i=this.constructor.resolveCollection(t);return e.call(this,i,n,r)};return _.isFunction(n.getter)&&(this["get"+e]=_.wrap(n.getter,r)),_.isFunction(n.setter)&&(this["set"+e]=_.wrap(n.setter,i)),_.isFunction(n.builder)&&(this["build"+e]=_.wrap(n.builder,s)),_.isFunction(n.creator)&&(this["create"+e]=_.wrap(n.creator,o)),this}})}),Backbone.sync=_.wrap(Backbone.sync,function(e,t,n,r){if(t!=="read")return e.call(this,t,n,r);var i=_.bind(function(e,t,n){delete this._locked,_.isFunction(e)&&e.call(this,this,t,n)},n),s=_.bind(function(e,t,n,i){u.resolve(t,n,i),_.isFunction(e)&&e.call(this,this,t,r)},n),o=_.bind(function(e,t,n,i){u.reject(t,n,i),_.isFunction(e)&&e.call(this,this,t,r)},n);_.extend(r,{complete:_.wrap(r.complete,i),success:_.wrap(r.success,s),error:_.wrap(r.error,o)});var u=$.Deferred(),a=[],f,l=_.bind(function(){e.call(this,"read",n,r)},n);return this instanceof Backbone.Model?f=this.associations:this instanceof Backbone.Collection&&(f=this.model.prototype.associations),_.each(f,function(e){var t,n=Backbone.Model.resolveRelation(e),i=Backbone.Model.resolveCollection(n);i!==r.associate&&(t=i.fetch({associate:this}),a.push(t))},this),this._locked||($.when.apply($,a).then(l),this._locked=!0),u.promise()})})();