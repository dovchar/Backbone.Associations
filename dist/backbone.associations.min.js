/**
 * Backbone.Associations v0.1.0
 * https://github.com/DreamTheater/Backbone.Associations
 *
 * Copyright Â© 2012 Dmytro Nemoga
 * Released under the MIT license.
 */
(function(){"use strict";var e=Backbone.Model;Backbone.Model=_.extend(function(t,n){n=_.extend({},n),this.associations=n.associations||this.associations||{},_.each(this.associations,function(e){var t=this._resolveRelation(e);this[t.type](e.as,{collection:t.collection,foreignKey:e.by})},this),e.apply(this,arguments)},e,{prototype:_.extend(e.prototype,{belongsTo:function(e,t){return this._createReference(e,{getter:function(e){var n=this.get(t.foreignKey);return e.get(n)},setter:function(e,n){return this.set(t.foreignKey,n.id)},builder:function(e,t){var n=e.model;return new n(t)},creator:function(e,t){return e.create(t)}},t)},hasOne:function(e,t){return this._createReference(e,{getter:function(e){var n={};return n[t.foreignKey]=this.id,e.where(n)[0]},setter:function(e,t){},builder:function(e,t){var n=e.model;return new n(t)},creator:function(e,t){return e.create(t)}},t)},hasMany:function(e,t){return this._createReference(e,{getter:function(e){return e}},t)},toJSON:_.wrap(e.prototype.toJSON,function(e,t){t=_.extend({associations:!1},t);var n=e.call(this,t);return t.associations,n}),_createReference:function(e,t,n){var r=function(e){var t=this._resolveCollection(n);return e.call(this,t)},i=function(e,t){var r=this._resolveCollection(n);return e.call(this,r,t)},s=function(e,t){var r=this._resolveCollection(n);return e.call(this,r,t)},o=function(e,t){var r=this._resolveCollection(n);return e.call(this,r,t)};return _.isFunction(t.getter)&&(this["get"+e]=_.wrap(t.getter,r)),_.isFunction(t.setter)&&(this["set"+e]=_.wrap(t.setter,i)),_.isFunction(t.builder)&&(this["build"+e]=_.wrap(t.builder,s)),_.isFunction(t.creator)&&(this["create"+e]=_.wrap(t.creator,o)),this},_resolveCollection:function(e){return _.result(e,"collection")},_resolveRelation:function(e){var t=_.pick(e,["belongsTo","hasOne","hasMany"]),n=_.keys(t)[0],r=t[n];return{type:n,collection:r}}})}),Backbone.sync=_.wrap(Backbone.sync,function(e,t,n,r){if(t!=="read")return e.call(this,t,n,r);r=_.extend({},r);var i=$.Deferred(),s=_.bind(function(e,t,n){delete this._xhrCache,_.isFunction(e)&&e.call(this,this,t,n)},n),o=_.bind(function(e,t,n,s){i.resolve(t,n,s),_.isFunction(e)&&e.call(this,this,t,r)},n),u=_.bind(function(e,t,n,s){i.reject(t,n,s),_.isFunction(e)&&e.call(this,this,t,r)},n),a=_.bind(function(){_.isUndefined(this._xhrCache)?this._xhrCache=e.call(this,"read",n,r):this._xhrCache.then(i.resolve,i.reject)},n);_.extend(r,{complete:_.wrap(r.complete,s),success:_.wrap(r.success,o),error:_.wrap(r.error,u)});var f,l=[];return this instanceof Backbone.Model?f=this.associations:this instanceof Backbone.Collection&&(f=this.model.prototype.associations),_.isArray(f)&&_.each(f,function(e){},this),$.when.apply($,l).then(a),i.promise()})})();